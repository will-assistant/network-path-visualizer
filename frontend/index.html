<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Path Visualizer ‚Äî V3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
        }
        .header {
            background: #111118;
            border-bottom: 1px solid #222;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header h1 {
            font-size: 18px;
            color: #4fc3f7;
            white-space: nowrap;
        }
        .header .version {
            font-size: 12px;
            color: #666;
            background: #1a1a25;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .controls {
            padding: 20px 24px;
            display: flex;
            gap: 12px;
            align-items: end;
            flex-wrap: wrap;
            background: #0d0d14;
            border-bottom: 1px solid #1a1a25;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .control-group label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        input, select {
            background: #1a1a25;
            border: 1px solid #333;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        input:focus, select:focus {
            border-color: #4fc3f7;
        }
        input { width: 280px; }
        select { min-width: 160px; }
        button {
            background: #4fc3f7;
            color: #000;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background: #81d4fa; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }

        .main {
            display: flex;
            height: calc(100vh - 130px);
        }
        .path-view {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        .detail-panel {
            width: 380px;
            background: #111118;
            border-left: 1px solid #222;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }
        .detail-panel.active { display: block; }
        .detail-panel h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #1a1a25;
            font-size: 13px;
        }
        .detail-row .key { color: #888; }
        .detail-row .val { color: #e0e0e0; font-family: 'SF Mono', monospace; font-size: 12px; }

        /* Path visualization */
        .path-container { margin-bottom: 24px; }
        .path-header {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .path-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .path-status.origin { background: #4caf50; }
        .path-status.not_in_inventory { background: #ff9800; }
        .path-status.blackhole { background: #f44336; }
        .path-status.loop { background: #f44336; }
        .path-status.unreachable { background: #f44336; }
        .path-status.max_hops { background: #ff9800; }

        .hop-chain {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0;
        }
        .hop-node {
            background: #1a1a25;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
            text-align: center;
        }
        .hop-node:hover {
            border-color: #4fc3f7;
            background: #1e1e30;
        }
        .hop-node.selected {
            border-color: #4fc3f7;
            box-shadow: 0 0 8px rgba(79, 195, 247, 0.3);
        }
        .hop-node .device-name {
            font-weight: 600;
            font-size: 13px;
            color: #fff;
        }
        .hop-node .hop-role {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        .hop-node .hop-proto {
            font-size: 10px;
            color: #4fc3f7;
            margin-top: 4px;
        }
        .hop-arrow {
            color: #444;
            font-size: 20px;
            padding: 0 6px;
            user-select: none;
        }
        .hop-node .plugin-badge {
            display: inline-block;
            font-size: 9px;
            padding: 1px 5px;
            border-radius: 3px;
            margin-top: 4px;
            background: #2a1a35;
            color: #ce93d8;
            border: 1px solid #4a2a5a;
        }
        .hop-note {
            font-size: 11px;
            color: #ff9800;
            margin-top: 2px;
        }
        .hop-entry-count {
            margin-top: 4px;
            font-size: 10px;
            color: #9ecfff;
        }
        .entry-list {
            margin-top: 10px;
            display: grid;
            gap: 6px;
            max-height: 250px;
            overflow-y: auto;
        }
        .entry-item {
            border: 1px solid #2a2a35;
            border-radius: 6px;
            padding: 8px;
            background: #141420;
            cursor: pointer;
            font-size: 12px;
            color: #bfcbe0;
        }
        .entry-item:hover { border-color: #3a4d6b; }
        .entry-item.active {
            border-color: #4fc3f7;
            background: #102133;
        }
        .entry-item .entry-id { color: #fff; font-weight: 600; margin-right: 6px; }
        .entry-item .entry-meta { color: #8aa2bf; }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #444;
        }
        .empty-state h2 { font-size: 20px; margin-bottom: 8px; color: #555; }
        .empty-state p { font-size: 14px; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4fc3f7;
        }
        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        @keyframes dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .error-msg {
            background: #2a1515;
            border: 1px solid #5a2020;
            color: #ef9a9a;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Network Path Visualizer</h1>
        <span class="version">V3 ‚Äî Generic Next-Hop Follower</span>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Destination Prefix</label>
            <input type="text" id="prefix" placeholder="e.g. 8.8.8.0/24" value="8.8.8.0/24">
        </div>
        <div class="control-group">
            <label>Starting Device</label>
            <select id="start-device">
                <option value="">Loading...</option>
            </select>
        </div>
        <div class="control-group">
            <label>VRF (optional)</label>
            <input type="text" id="vrf" placeholder="default" style="width: 140px;">
        </div>
        <button id="trace-btn" onclick="runTrace()">Trace</button>
        <button id="reverse-btn" onclick="runCompare()" style="background:#ff7043">Reverse Trace</button>
        <button id="fail-btn" onclick="runFailure()" style="background:#ffd54f">Simulate Failure</button>
    </div>

    <div class="main">
        <div class="path-view" id="path-view">
            <div id="summary" style="margin-bottom:10px;color:#9ecfff"></div>
            <div class="empty-state">
                <h2>Enter a prefix and start tracing</h2>
                <p>Follow the routing table hop by hop</p>
            </div>
        </div>
        <div class="detail-panel" id="detail-panel">
            <h3>Hop Details</h3>
            <div id="detail-content"></div>
        </div>
    </div>

    <script>
        let lastResult = null;

        // Load devices into dropdown
        async function loadDevices() {
            try {
                const resp = await fetch('/api/devices');
                const data = await resp.json();
                const sel = document.getElementById('start-device');
                sel.innerHTML = '';
                for (const dev of data.devices) {
                    const opt = document.createElement('option');
                    opt.value = dev.hostname;
                    opt.textContent = `${dev.hostname}${dev.role ? ' (' + dev.role + ')' : ''}`;
                    sel.appendChild(opt);
                }
            } catch (e) {
                console.error('Failed to load devices:', e);
            }
        }

        async function runTrace() {
            const prefix = document.getElementById('prefix').value.trim();
            const startDevice = document.getElementById('start-device').value;
            const vrf = document.getElementById('vrf').value.trim() || null;

            if (!prefix || !startDevice) return;

            const btn = document.getElementById('trace-btn');
            const view = document.getElementById('path-view');
            btn.disabled = true;
            view.innerHTML = '<div class="loading">Tracing route</div>';
            document.getElementById('detail-panel').classList.remove('active');

            try {
                const resp = await fetch('/api/trace', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prefix, start_device: startDevice, vrf }),
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    view.innerHTML = `<div class="error-msg">Error: ${err.detail || resp.statusText}</div>`;
                    return;
                }

                lastResult = await resp.json();
                renderPaths(lastResult);
            } catch (e) {
                view.innerHTML = `<div class="error-msg">Request failed: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        }

        function getAllEntries(hop) {
            if (hop && Array.isArray(hop.all_entries) && hop.all_entries.length > 0) {
                return hop.all_entries.map((entry, idx) => ({
                    index: idx,
                    next_hop: entry.next_hop || '',
                    as_path: Array.isArray(entry.as_path) ? entry.as_path : [],
                    lp: entry.lp,
                    metric: entry.metric,
                    active: Boolean(entry.active),
                }));
            }
            return [{
                index: 0,
                next_hop: hop?.next_hop || '',
                as_path: Array.isArray(hop?.as_path) ? hop.as_path : [],
                lp: hop?.lp,
                metric: hop?.metric,
                active: true,
            }];
        }

        function getDefaultEntryIndex(entries) {
            const activeIdx = entries.findIndex(e => e.active);
            return activeIdx >= 0 ? activeIdx : 0;
        }

        function renderPaths(result) {
            const summary = document.getElementById("summary");
            const hops = (result.paths||[]).reduce((a,p)=>a+(p.hops||[]).length,0);
            const domains = (result.domain_crossings||[]).length;
            const labels = (result.paths||[]).flatMap(p=>p.hops||[]).flatMap(h=>h.labels||[]).length;
            const allHopEntries = (result.paths||[]).flatMap(p => p.hops || []).map(h => getAllEntries(h));
            const routeEntries = allHopEntries.reduce((a, entries) => a + entries.length, 0);
            const activeEntries = allHopEntries.reduce((a, entries) => a + entries.filter(e => e.active).length, 0);
            summary.textContent = `Summary: total hops=${hops}, route entries=${routeEntries} (${activeEntries} active), domains crossed=${domains}, label ops=${labels}, origin=${result.origin_type||"unknown"}`;
            const view = document.getElementById('path-view');

            if (!result.paths || result.paths.length === 0) {
                view.innerHTML = '<div class="empty-state"><h2>No paths found</h2></div>';
                return;
            }

            let html = `<div style="margin-bottom:16px;color:#888;font-size:13px;">
                Prefix: <strong style="color:#fff">${result.prefix}</strong> from 
                <strong style="color:#fff">${result.start}</strong> ‚Äî 
                ${result.paths.length} path${result.paths.length > 1 ? 's' : ''} found
            </div>`;

            result.paths.forEach((path, pi) => {
                const statusClass = path.end_reason || 'unknown';
                const reasonLabel = {
                    origin: '‚úì Origin found',
                    blackhole: '‚úó Blackhole',
                    not_in_inventory: '‚ö† Left known network',
                    loop: '‚úó Loop detected',
                    unreachable: '‚úó Device unreachable',
                    max_hops: '‚ö† Max hops reached',
                }[path.end_reason] || path.end_reason;

                html += `<div class="path-container">`;
                html += `<div class="path-header">
                    <span class="path-status ${statusClass}"></span>
                    Path ${pi + 1}: ${reasonLabel}
                    <span style="color:#555">‚Äî ${path.hops.length} hop${path.hops.length !== 1 ? 's' : ''}</span>
                </div>`;
                html += `<div class="hop-chain">`;

                path.hops.forEach((hop, hi) => {
                    if (hi > 0) {
                        html += `<span class="hop-arrow">‚Üí</span>`;
                    }

                    // Plugin badges
                    let badges = '';
                    if (hop.plugin_labels) {
                        for (const [plugin, labels] of Object.entries(hop.plugin_labels)) {
                            for (const [k, v] of Object.entries(labels)) {
                                badges += `<span class="plugin-badge">${k}: ${v}</span> `;
                            }
                        }
                    }

                    const entries = getAllEntries(hop);
                    const defaultEntryIdx = getDefaultEntryIndex(entries);
                    const entryCount = entries.length;
                    const activeCount = entries.filter(e => e.active).length;
                    html += `<div class="hop-node" onclick="showDetail(${pi}, ${hi}, ${defaultEntryIdx})">
                        <div class="device-name">${hop.device}</div>
                        ${hop.role ? `<div class="hop-role">${hop.role}</div>` : ''}
                        ${hop.protocol ? `<div class="hop-proto">${hop.protocol.toUpperCase()}</div>` : ''}
                        ${entryCount > 1 ? `<div class="hop-entry-count">${entryCount} route entries (${activeCount} active)</div>` : ''}
                        ${badges}
                        ${hop.note ? `<div class="hop-note">${hop.note}</div>` : ''}
                    </div>`;
                });

                html += `</div></div>`;
            });

            view.innerHTML = html;
        }

        function showDetail(pathIdx, hopIdx, entryIdx = null) {
            if (!lastResult) return;

            const hop = lastResult.paths[pathIdx].hops[hopIdx];
            const allEntries = getAllEntries(hop);
            const resolvedEntryIdx = entryIdx === null ? getDefaultEntryIndex(allEntries) : entryIdx;
            const selectedEntry = allEntries[Math.max(0, Math.min(resolvedEntryIdx, allEntries.length - 1))];

            const panel = document.getElementById('detail-panel');
            const content = document.getElementById('detail-content');

            // Clear selection
            document.querySelectorAll('.hop-node').forEach(n => n.classList.remove('selected'));
            // Select this one
            const chains = document.querySelectorAll('.hop-chain');
            if (chains[pathIdx]) {
                const nodes = chains[pathIdx].querySelectorAll('.hop-node');
                if (nodes[hopIdx]) nodes[hopIdx].classList.add('selected');
            }

            let html = '';
            const rows = [
                ['Device', hop.device],
                ['Role', hop.role],
                ['Protocol', hop.protocol],
                ['Selected Entry', `${selectedEntry.index + 1} / ${allEntries.length}`],
                ['Next Hop', selectedEntry.next_hop || hop.next_hop],
                ['Interface', hop.interface],
                ['Local Pref', selectedEntry.lp ?? hop.lp],
                ['Metric', selectedEntry.metric ?? hop.metric],
                ['VRF', hop.vrf],
                ['AS Path', (selectedEntry.as_path || hop.as_path || []).join(' ')],
                ['Communities', hop.communities ? hop.communities.join(', ') : ''],
            ];

            for (const [key, val] of rows) {
                if (val !== null && val !== undefined && val !== '') {
                    html += `<div class="detail-row"><span class="key">${key}</span><span class="val">${val}</span></div>`;
                }
            }

            if (allEntries.length > 1) {
                html += `<h3 style="margin-top:16px">All Route Entries (${allEntries.length})</h3><div class="entry-list">`;
                for (const entry of allEntries) {
                    const asText = entry.as_path.length ? entry.as_path.join(' ') : 'n/a';
                    const lpText = entry.lp ?? 'n/a';
                    const metricText = entry.metric ?? 'n/a';
                    html += `<div class="entry-item ${entry.index === selectedEntry.index ? 'active' : ''}" onclick="showDetail(${pathIdx}, ${hopIdx}, ${entry.index})">
                        <span class="entry-id">#${entry.index + 1}${entry.active ? ' ‚òÖ' : ''}</span>
                        <span class="entry-meta">${entry.next_hop || 'n/a'} ¬∑ LP ${lpText} ¬∑ MED ${metricText}</span>
                        <div class="entry-meta" style="margin-top:3px">AS ${asText}</div>
                    </div>`;
                }
                html += `</div>`;
            }

            if (hop.plugin_labels && Object.keys(hop.plugin_labels).length > 0) {
                html += `<h3 style="margin-top:16px">Plugin Labels</h3>`;
                for (const [plugin, labels] of Object.entries(hop.plugin_labels)) {
                    for (const [k, v] of Object.entries(labels)) {
                        html += `<div class="detail-row"><span class="key">${plugin}: ${k}</span><span class="val">${v}</span></div>`;
                    }
                }
            }

            if (hop.note) {
                html += `<div style="margin-top:12px;padding:8px;background:#2a2a15;border-radius:4px;font-size:12px;color:#ff9800">${hop.note}</div>`;
            }

            content.innerHTML = html;
            panel.classList.add('active');
        }

        // Handle Enter key
        document.getElementById('prefix').addEventListener('keydown', e => {
            if (e.key === 'Enter') runTrace();
        });

        

        async function runCompare() {
            const destination = document.getElementById('prefix').value.trim();
            const source = document.getElementById('start-device').value;
            const resp = await fetch('/api/trace/compare', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({source, destination})});
            const data = await resp.json();
            if (!resp.ok) return;
            renderPaths(data.forward_path);
            const div = document.createElement('div');
            div.className = 'error-msg';
            div.style.background = data.symmetric ? '#153022' : '#301515';
            div.style.borderColor = data.symmetric ? '#2e7d32' : '#8d2a2a';
            div.innerHTML = data.symmetric ? 'Forward and reverse paths are symmetric' : `Asymmetry detected at hops: ${data.divergence_points.join(', ')}`;
            document.getElementById('path-view').prepend(div);
        }

        async function runFailure() {
            const destination = document.getElementById('prefix').value.trim();
            const source = document.getElementById('start-device').value;
            const failedNode = prompt('Enter failed node hostname');
            if (!failedNode) return;
            const resp = await fetch('/api/simulate/failure', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({source, destination, failed_node: failedNode})});
            const data = await resp.json();
            if (!resp.ok) return;
            renderPaths(data.failover);
            const div = document.createElement('div');
            div.className = 'error-msg';
            div.innerHTML = `Failure sim: ${data.impact_summary}`;
            document.getElementById('path-view').prepend(div);
        }

        // Init
        loadDevices();
    </script>
</body>
</html>
